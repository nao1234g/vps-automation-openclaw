# AISA データ自動収集パイプライン設計書（v3 完全版）

## 目的
AISAニュースレターを支える24時間自動データ収集・分析・レポート生成・モニタリング・バックアップパイプライン。

---

## 1. 全体アーキテクチャ（実装済み — 12ワークフロー）

```
┌──────────────────────────────────────────────────────────────────┐
│                  N8N ワークフロー（VPS上）                          │
│                                                                  │
│  ┌─────────────────── Data Collection ──────────────────┐       │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐              │       │
│  │  │ ① 規制   │ │ ② 市場   │ │ ⑤ SNS    │              │       │
│  │  │ ニュース │ │ データ   │ │ シグナル │              │       │
│  │  │ 9:00 JST │ │ 9/21 JST │ │ 15:00    │              │       │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘              │       │
│  └───────┼────────────┼────────────┼────────────────────┘       │
│          │            │            │                            │
│          v            v            v                            │
│  ┌──────────────────────────────────────────┐                   │
│  │          PostgreSQL DB (aisa)             │                   │
│  │  regulatory_news | market_data           │                   │
│  │  social_signals  | generated_reports     │                   │
│  │  subscriber_metrics                      │                   │
│  └──────────┬──────────┬──────────┬─────────┘                   │
│             │          │          │                              │
│  ┌──── Report Gen ────┐│  ┌── Monitoring ──────────┐            │
│  │  ┌────────┐┌──────┐││  │ ┌────────┐┌──────────┐│            │
│  │  │③ 週次  ││⑥Notes│││  │ │④ 品質  ││⑦ Flash  ││            │
│  │  │レポート││下書き│││  │ │ 監視   ││ Alert   ││            │
│  │  │月曜10h ││14:00 │││  │ │12:00   ││ 4h毎    ││            │
│  │  └───┬────┘└──┬───┘││  │ └───┬────┘└────┬─────┘│            │
│  │      │        │    ││  │     │          │      │            │
│  │  ┌───┘  ┌─────┘    ││  │ ┌───┘   ┌──────┘      │            │
│  │  │⑧月次 │          ││  │ │⑨Dash │⑪Metrics    │            │
│  │  │1日/月 │          ││  │ │8:00   │21:00        │            │
│  │  └──┬───┘          ││  │ └──┬────┘└──┬──────────┘            │
│  └─────┼──────────────┘│  └────┼────────┼───────────            │
│        │       │       │       │        │                       │
│        v       v       v       v        v                       │
│  ┌──────────────────────────────────────────┐                   │
│  │     Telegram → Nao に全通知集約           │                   │
│  │  📊 レポート / 📝 Notes / ⚠️ アラート      │                   │
│  │  🏠 ダッシュボード / 📈 メトリクス         │                   │
│  └──────────────────────────────────────────┘                   │
│                                                                  │
│  ┌─────────────── Maintenance ──────────────┐                   │
│  │  ⑩ 重複排除(日曜3:00)  ⑫ バックアップ(日曜6:00)  │           │
│  └──────────────────────────────────────────┘                   │
│                                                                  │
│  ┌─────────────── Error Handling ───────────┐                   │
│  │  全コアWFにOnError→Telegram通知を搭載     │                   │
│  └──────────────────────────────────────────┘                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. ワークフロー一覧（全12本 AISA + 1 Jarvis、全 active=True）

### コアパイプライン
| # | 名前 | N8N ID | スケジュール | ノード数 | エラーハンドリング |
|---|---|---|---|---|---|
| ① | Regulatory News Collection | gNlTlUD1Blws3UPF | 毎日 9:00 JST | 11 | ✅ OnError→TG |
| ② | Market Data Collection | QDGB5q1PaEXhThq4 | 毎日 9:00/21:00 JST | 10 | ✅ OnError→TG |
| ⑤ | Social Signal Collector | 1kt8rq3IBC8RyWRf | 毎日 15:00 JST | 25 | ✅ OnError→TG |

### レポート生成
| # | 名前 | N8N ID | スケジュール | ノード数 | エラーハンドリング |
|---|---|---|---|---|---|
| ③ | Weekly Report Generator | vgQ6JPAaToo0eKGX | 毎週月曜 10:00 JST | 11 | ✅ OnError→TG |
| ⑥ | Daily Notes Draft Generator | yrfGeWCagCNIlaZj | 毎日 14:00 JST | - | - |
| ⑧ | Monthly Report Generator | oLNetUY9cik8ybbM | 毎月1日 11:00 JST | - | - |

### モニタリング＆通知
| # | 名前 | N8N ID | スケジュール | ノード数 | 機能 |
|---|---|---|---|---|---|
| ④ | Data Quality Monitor | DU1XXiFqdJnAW21K | 毎日 12:00 JST | - | DB件数比較 |
| ⑦ | Flash Alert Monitor | tvNzNjo0pYHe39Qx | 4時間毎 | 8 | ✅ OnError→TG |
| ⑨ | Daily Dashboard Summary | JMt5LdPDyihfkFd4 | 毎日 8:00 JST | - | パイプライン健全性 |
| ⑪ | Daily Metrics Tracker | mbsUu4ImH90P8GE0 | 毎日 21:00 JST | - | 成長メトリクスリマインド |

### メンテナンス
| # | 名前 | N8N ID | スケジュール | 機能 |
|---|---|---|---|---|
| ⑩ | Data Integrity & Dedup | 7t052TeExxQ4H8Yb | 毎週日曜 3:00 JST | URLベース重複排除 + 品質レポート |
| ⑫ | Weekly Data Backup | IaRXNFXToEFIwSdR | 毎週日曜 6:00 JST | 全テーブルJSON export + 通知 |

### その他
| # | 名前 | N8N ID | スケジュール |
|---|---|---|---|
| - | Morning Briefing by Jarvis | 64hCI3XkGQG17oaH | 毎朝 |

---

## 3. データソース詳細

### A. 規制ニュース（ワークフロー①）

| 国 | ソース | URL | 方式 | 状態 |
|---|---|---|---|---|
| 🇯🇵 日本 | FSA | https://www.fsa.go.jp/en/news/index.html | HTML Parse | ✅ |
| 🇭🇰 香港 | SFC | https://www.sfc.hk/en/RSS-Feeds | RSS | ✅ |
| 🇸🇬 SG | MAS | https://www.mas.gov.sg/news | HTML Parse | ✅ |
| 🇰🇷 韓国 | CryptoCompare | News API (Asia keywords) | JSON API | ✅ |
| 🌏 全般 | CryptoCompare | News API (Regulation) | JSON API | ✅ |

**注記**: 韓国FSC (fsc.go.kr) はJS描画のためスクレイピング不可。CryptoCompare Newsで代替。

### B. 市場データ（ワークフロー②）

| ソース | エンドポイント | 内容 | 制限 |
|---|---|---|---|
| CoinGecko | /coins/markets | BTC,ETH,XRP,VIRTUAL,ASTAR,JASMY,SOL 価格 | 30回/分 |
| CoinGecko | /simple/price | JPY/USD為替レート | 同上 |
| DefiLlama | /v2/chains | チェーン別TVL | 無制限 |
| DefiLlama | /stablecoins | ステーブルコイン供給量 | 無制限 |

### C. ソーシャルシグナル（ワークフロー⑤）— 25ノード

| ソース | URL | 内容 | Asia Filter |
|---|---|---|---|
| Reddit r/CryptoCurrency | /new.json | 新着投稿 | キーワードフィルター |
| Reddit r/JapanFinance | /new.json | 新着投稿 | 全通過（固有Asia） |
| Reddit r/ethereum | /new.json | 新着投稿 | キーワードフィルター |
| CryptoCompare News | /data/v2/news/ | 最新ニュース50件 | キーワードフィルター |
| CryptoCompare News Asia | /data/v2/news/?categories=Regulation | 規制ニュース | 全通過 |
| The Block RSS | /rss.xml | ニュース | キーワードフィルター |
| CoinDesk RSS | /feed | ニュース | キーワードフィルター |
| Decrypt RSS | /feed | ニュース | キーワードフィルター |

**Asiaキーワード**: japan, korea, hong kong, singapore, fsa, fsc, sfc, mas, yen, won, asia, tokyo, seoul 等 40+語

**処理フロー**: 取得 → パース → Asiaフィルター → エンゲージメントスコア計算 → センチメント分析 → トピック抽出 → DB INSERT (ON CONFLICT DO NOTHING)

---

## 4. データベース設計（実装済み）

### PostgreSQL スキーマ: `aisa`（openclaw-postgres内）

5テーブル:
- `regulatory_news` — 規制ニュース（country, source, title, url, importance, published_at）
- `market_data` — 市場データ（source, data_type, asset_id, value_usd, value_jpy, metadata）
- `social_signals` — ソーシャル（platform, author, content, url, engagement_score, sentiment, topics[]）
- `generated_reports` — 自動生成レポート（report_number, title, content_md, report_type）
- `subscriber_metrics` — 成長追跡（date, free_subscribers, paid_subscribers, newsletter_opens, clicks, notes_views）

### インデックス
- `idx_subscriber_metrics_date` ON subscriber_metrics(date)
- `social_signals` ON CONFLICT(url) DO NOTHING（重複防止）

### 接続情報
- Host: `postgres` (Docker内部)
- DB: `openclaw`
- User: `openclaw`
- N8N Credential ID: `cvjLsJQ5SelNrTO5`

---

## 5. エラーハンドリング

### OnError Telegram通知
以下のコアワークフローにエラーハンドラーを搭載:
- ① Regulatory News Collection
- ② Market Data Collection
- ⑤ Social Signal Collector
- ③ Weekly Report Generator
- ⑦ Flash Alert Monitor

エラー発生時、以下のフォーマットでNaoのTelegramに即座に通知:
```
🚨 AISA Pipeline Error
⚠️ Workflow: [WF名]
Error: [エラーメッセージ]
Time: [発生時刻]
```

### データ整合性
- ⑩ 毎週日曜 3:00 JST に自動重複排除
- URLベースの重複検出（regulatory_news, social_signals）
- NULL/空データのカウントレポート

---

## 6. N8N認証情報

- **API Key**: `n8n_api_d1d0a1aaca1a0512a91f500714c1918e8a80555476b81c9f`
- **ユーザー**: `admin@openclaw.local`
- **UI URL**: http://[VPS_IP]:5678
- **Telegram Bot Token**: `8411746858:AAER08xoYMDQz8DKM8GCmVj0OATbMn7pmIw`
- **Telegram Chat ID**: `8309763101`

---

## 7. 24時間タイムライン

```
03:00 JST → ⑩  日曜のみ：データ重複排除 & 整合性チェック → TG通知
06:00 JST → ⑫  日曜のみ：全テーブル自動バックアップ → TG通知
08:00 JST → ⑨  デイリーダッシュボード（健全性+価格+統計）→ TG
09:00 JST → ①② 規制ニュース + 市場データ自動収集
10:00 JST → ③  月曜のみ：週次レポート自動生成（SEO+Social統合）→ TG
11:00 JST → ⑧  月初のみ：月次レポート自動生成 → TG
12:00 JST → ④  パイプライン健全性チェック → 異常時TG通知
14:00 JST → ⑥  Notes下書き2本自動生成 → TG
15:00 JST → ⑤  ソーシャルシグナル収集（Reddit/RSS/CryptoCompare）
21:00 JST → ②  市場データ2回目の自動収集
21:00 JST → ⑪  メトリクスリマインダー → TG
随時(4h) → ⑦  フラッシュアラート監視 → 重要ニュース即時TG
随時     → 🚨  OnError通知 → パイプラインエラー即時TG
```

---

## 8. コスト（月額）

| 項目 | 費用 |
|---|---|
| CoinGecko API（Free） | ¥0 |
| DefiLlama API | ¥0 |
| CryptoCompare News API | ¥0 |
| Reddit JSON API | ¥0 |
| RSS feeds | ¥0 |
| PostgreSQL | ¥0（既存VPS） |
| N8N | ¥0（セルフホスト） |
| Substack | ¥0 |
| **合計** | **¥0/月** |

**損益分岐点**: Paid subscriber 4人（$60/月）> VPS費用（$50/月）

---

## 9. 6ヶ月後の蓄積データ予測

| データ | 蓄積量 |
|---|---|
| 規制ニュース | 約500-1,000件 |
| 市場データポイント | 約10,000件 |
| ソーシャルシグナル | 約3,000-5,000件 |
| 週次レポート | 26本 |
| 月次レポート | 6本 |
| Notes下書き | 365本 |
| バックアップ | 26回 |

**→ これが「堀（moat）」。後発が半年かけないと追いつけないデータ資産。**

---

## 10. 既知の制約と対策

| 制約 | 対策 |
|---|---|
| 韓国FSC: JS描画でスクレイピング不可 | CryptoCompare News APIで代替 |
| CoinGecko Free: 月10,000コール上限 | 1日2回×少数エンドポイントで月600コール（余裕） |
| CoinDesk RSS: URL変更が頻繁 | 品質監視WF④で検知 + OnErrorアラート |
| Reddit rate limit | User-Agent設定 + 1日1回に制限 |
| LLM APIなし（レポート生成） | SQL集計+テンプレートで生成（LLM不要） |
| Telegram getUpdates競合 | Jarvisと共存不可 → プッシュ型通知に統一 |

---

## 11. WF③ 週次レポート — SEO & Social Signals 統合

### 追加された機能（v3）
- **動的SEOタイトル生成**: その週のトップストーリーに基づき自動でSEOに最適化されたタイトルを生成
- **Social Signals統合**: `aisa.social_signals` テーブルからセンチメント分析とトップ投稿を引用
- **ペイウォールマーカー**: `<!-- PAYWALL START -->` / `<!-- PAYWALL END -->` を自動挿入
- **プロフェッショナルなMarkdown**: TL;DR、国別規制セクション、市場テーブル、ソーシャルインテリジェンスを構造化
- **9ノード構成**: Schedule → Get Regulatory + Market + Stats + Social + Sentiment → Generate Report → Save DB → Telegram

---

*設計・構築: Neo（2026-02-14〜15）*
*全12 AISAワークフロー + 1 Jarvis = 13ワークフロー active=True で24時間自動稼働中*
