# AISA データダッシュボード SQL クエリ集
## 将来的にWebダッシュボード化する際のベースクエリ

---

## 1. 規制ニュースダッシュボード

### 国別ニュース件数（過去30日）
```sql
SELECT
  country,
  COUNT(*) as total_news,
  COUNT(*) FILTER (WHERE importance = 'high') as high_priority,
  MIN(collected_at) as earliest,
  MAX(collected_at) as latest
FROM aisa.regulatory_news
WHERE collected_at >= NOW() - INTERVAL '30 days'
GROUP BY country
ORDER BY total_news DESC;
```

### 日別ニュース件数推移
```sql
SELECT
  DATE(collected_at) as date,
  country,
  COUNT(*) as news_count
FROM aisa.regulatory_news
WHERE collected_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE(collected_at), country
ORDER BY date DESC, country;
```

### 最新ニュース（上位20件）
```sql
SELECT
  country, source, title, url, importance,
  collected_at AT TIME ZONE 'Asia/Tokyo' as collected_jst
FROM aisa.regulatory_news
ORDER BY collected_at DESC
LIMIT 20;
```

---

## 2. 市場データダッシュボード

### 最新価格一覧
```sql
SELECT DISTINCT ON (asset_id)
  asset_id,
  value_usd,
  value_jpy,
  collected_at AT TIME ZONE 'Asia/Tokyo' as updated_jst,
  metadata
FROM aisa.market_data
WHERE data_type = 'price'
ORDER BY asset_id, collected_at DESC;
```

### 7日間価格推移
```sql
SELECT
  asset_id,
  DATE(collected_at) as date,
  AVG(value_usd)::DECIMAL(20,4) as avg_price_usd,
  AVG(value_jpy)::DECIMAL(20,2) as avg_price_jpy
FROM aisa.market_data
WHERE data_type = 'price'
  AND collected_at >= NOW() - INTERVAL '7 days'
GROUP BY asset_id, DATE(collected_at)
ORDER BY asset_id, date;
```

### 週次パフォーマンスランキング
```sql
WITH first_price AS (
  SELECT DISTINCT ON (asset_id)
    asset_id, value_usd as start_price
  FROM aisa.market_data
  WHERE data_type = 'price'
    AND collected_at >= NOW() - INTERVAL '7 days'
  ORDER BY asset_id, collected_at ASC
),
last_price AS (
  SELECT DISTINCT ON (asset_id)
    asset_id, value_usd as end_price
  FROM aisa.market_data
  WHERE data_type = 'price'
  ORDER BY asset_id, collected_at DESC
)
SELECT
  f.asset_id,
  f.start_price,
  l.end_price,
  ROUND(((l.end_price - f.start_price) / NULLIF(f.start_price, 0) * 100)::numeric, 2) as change_pct
FROM first_price f
JOIN last_price l ON f.asset_id = l.asset_id
ORDER BY change_pct DESC;
```

### TVLデータ（チェーン別）
```sql
SELECT DISTINCT ON (asset_id)
  asset_id as chain,
  value_usd as tvl_usd,
  metadata,
  collected_at AT TIME ZONE 'Asia/Tokyo' as updated_jst
FROM aisa.market_data
WHERE data_type = 'tvl'
ORDER BY asset_id, collected_at DESC;
```

### ステーブルコイン供給量
```sql
SELECT DISTINCT ON (asset_id)
  asset_id as stablecoin,
  value_usd as supply_usd,
  metadata,
  collected_at AT TIME ZONE 'Asia/Tokyo' as updated_jst
FROM aisa.market_data
WHERE data_type = 'stablecoin_supply'
ORDER BY asset_id, collected_at DESC;
```

---

## 3. ソーシャルシグナルダッシュボード

### プラットフォーム別件数
```sql
SELECT
  platform,
  COUNT(*) as total_signals,
  AVG(engagement_score)::INT as avg_engagement,
  COUNT(*) FILTER (WHERE sentiment = 'positive') as positive,
  COUNT(*) FILTER (WHERE sentiment = 'negative') as negative,
  COUNT(*) FILTER (WHERE sentiment = 'neutral') as neutral
FROM aisa.social_signals
WHERE collected_at >= NOW() - INTERVAL '7 days'
GROUP BY platform
ORDER BY total_signals DESC;
```

### トレンディングトピック（過去7日）
```sql
SELECT
  unnest(topics) as topic,
  COUNT(*) as mention_count,
  AVG(engagement_score)::INT as avg_engagement
FROM aisa.social_signals
WHERE collected_at >= NOW() - INTERVAL '7 days'
GROUP BY topic
ORDER BY mention_count DESC
LIMIT 10;
```

### 日別センチメント推移
```sql
SELECT
  DATE(collected_at) as date,
  COUNT(*) as total,
  ROUND(COUNT(*) FILTER (WHERE sentiment = 'positive')::DECIMAL / NULLIF(COUNT(*), 0) * 100, 1) as positive_pct,
  ROUND(COUNT(*) FILTER (WHERE sentiment = 'negative')::DECIMAL / NULLIF(COUNT(*), 0) * 100, 1) as negative_pct
FROM aisa.social_signals
WHERE collected_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE(collected_at)
ORDER BY date DESC;
```

### 高エンゲージメント投稿
```sql
SELECT
  platform, author,
  LEFT(content, 200) as content_preview,
  url, engagement_score, sentiment, topics
FROM aisa.social_signals
WHERE collected_at >= NOW() - INTERVAL '7 days'
ORDER BY engagement_score DESC
LIMIT 10;
```

---

## 4. レポートアーカイブ

### 全レポート一覧
```sql
SELECT
  report_number, title, report_type,
  created_at AT TIME ZONE 'Asia/Tokyo' as created_jst,
  LENGTH(content_md) as content_length,
  substack_post_id
FROM aisa.generated_reports
ORDER BY created_at DESC;
```

### レポート検索（キーワード）
```sql
SELECT
  report_number, title, report_type,
  created_at AT TIME ZONE 'Asia/Tokyo' as created_jst
FROM aisa.generated_reports
WHERE content_md ILIKE '%[KEYWORD]%'
ORDER BY created_at DESC;
```

---

## 5. パイプライン健全性モニター

### テーブル別最新更新時刻
```sql
SELECT 'regulatory_news' as tbl, MAX(collected_at) as latest, COUNT(*) as total FROM aisa.regulatory_news
UNION ALL
SELECT 'market_data', MAX(collected_at), COUNT(*) FROM aisa.market_data
UNION ALL
SELECT 'social_signals', MAX(collected_at), COUNT(*) FROM aisa.social_signals
UNION ALL
SELECT 'generated_reports', MAX(created_at), COUNT(*) FROM aisa.generated_reports
ORDER BY tbl;
```

### 日別データ収集量
```sql
SELECT
  DATE(collected_at) as date,
  'regulatory_news' as source,
  COUNT(*) as records
FROM aisa.regulatory_news
WHERE collected_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE(collected_at)
UNION ALL
SELECT
  DATE(collected_at),
  'market_data',
  COUNT(*)
FROM aisa.market_data
WHERE collected_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE(collected_at)
UNION ALL
SELECT
  DATE(collected_at),
  'social_signals',
  COUNT(*)
FROM aisa.social_signals
WHERE collected_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE(collected_at)
ORDER BY date DESC, source;
```

---

## 6. 将来のWebダッシュボード化

### 技術スタック候補
| 選択肢 | メリット | コスト |
|---|---|---|
| **Metabase** (Docker) | SQLクエリ → 自動グラフ、VPS上にデプロイ可能 | ¥0 |
| **Grafana** (Docker) | リアルタイムダッシュボード、アラート機能 | ¥0 |
| **Streamlit** (Python) | カスタムUI、最も柔軟 | ¥0 |
| **Substack + 画像** | スクリーンショット埋め込み、追加インフラ不要 | ¥0 |

### 推奨: Phase 1 → Metabase
- Docker Composeに1行追加するだけ
- SQLクエリをそのまま使える
- 自動更新ダッシュボード
- URLを有料読者にシェア可能

```yaml
# docker-compose.quick.yml に追加
metabase:
  image: metabase/metabase:latest
  ports:
    - "3000:3000"
  environment:
    MB_DB_TYPE: postgres
    MB_DB_HOST: postgres
    MB_DB_PORT: 5432
    MB_DB_DBNAME: openclaw
    MB_DB_USER: openclaw
    MB_DB_PASS: change_me_in_production
  depends_on:
    - postgres
```

---

*最終更新: 2026-02-14 Neo*
