"""
Nowpattern Deep Pattern — イラン・ホルムズ海峡一時封鎖
2026-02-18 実記事投稿スクリプト（Ghost + X）
"""
import sys, os
sys.path.insert(0, "/opt/shared/scripts")
if sys.stdout.encoding != "utf-8":
    sys.stdout.reconfigure(encoding="utf-8")

from nowpattern_article_builder import build_deep_pattern_html
from nowpattern_publisher import publish_deep_pattern
from gen_dynamics_diagram import generate_dynamics_diagram

# ===================================================================
# 1. ダイアグラム生成
# ===================================================================
diagram_svg = generate_dynamics_diagram(
    diagram_type="flow",
    title="ホルムズ海峡の力学構造",
    nodes=[
        {"id": "iran", "label": "イラン\nIRGC", "type": "power"},
        {"id": "us", "label": "米国\nトランプ政権", "type": "power"},
        {"id": "oil", "label": "世界石油市場\n日量1300万バレル", "type": "affected"},
        {"id": "gulf", "label": "湾岸諸国\nサウジ・UAE", "type": "neutral"},
        {"id": "talks", "label": "核協議\nジュネーブ", "type": "regulator"},
    ],
    edges=[
        {"from": "iran", "to": "oil", "label": "封鎖カード", "type": "dominance"},
        {"from": "us", "to": "iran", "label": "軍事圧力", "type": "dominance"},
        {"from": "iran", "to": "talks", "label": "交渉テコ", "type": "capture"},
        {"from": "us", "to": "talks", "label": "最後通牒", "type": "dominance"},
        {"from": "oil", "to": "gulf", "label": "価格連動", "type": "flow"},
        {"from": "gulf", "to": "talks", "label": "仲介圧力", "type": "regulation"},
    ],
)

# ===================================================================
# 2. 記事コンテンツ（builderの正しいAPI形式）
# ===================================================================
article_id = "dp-2026-0218-001"

html = build_deep_pattern_html(
    title="イランがホルムズ海峡を一時封鎖した構造",
    why_it_matters=(
        "世界の石油輸送の20%（日量1,300万バレル）が通過するホルムズ海峡を、"
        "イラン革命防衛隊が軍事演習名目で初めて公式に一時閉鎖した。"
        "核協議の裏で行われたこの「封鎖カード」の行使は、中東の地政学リスクが "
        "石油市場・世界経済を直撃する構造を改めて露呈した。"
    ),
    facts=[
        ("IRGC演習", "イラン革命防衛隊が「ホルムズ海峡スマートコントロール」演習を実施。巡航ミサイルの実弾発射映像を国営テレビで公開した"),
        ("数時間封鎖", "2月17日、安全上の予防措置として海峡の一部を数時間閉鎖。民間船舶の航行を一時停止させた"),
        ("核協議と同時", "ジュネーブで米・イラン間接核協議の第2ラウンドが開催中。イラン外相は「指導原則で合意」と発表"),
        ("米空母2隻", "トランプ大統領がUSS Gerald Ford（世界最大の空母）を中東に派遣。USS Abraham Lincolnと合わせ空母2隻体制に"),
        ("ハメネイ発言", "イラン最高指導者が「軍艦は確かに危険な兵器だが、それを沈める兵器のほうがもっと危険だ」と米国を牽制"),
        ("原油価格上昇", "ブレント原油が一時$67.50/バレルまで上昇。封鎖終了後に上げ幅を縮小"),
        ("1300万バレル/日", "ホルムズ海峡を通過する原油は日量約1,300万バレル（2025年）。世界の海上原油輸送の31%を占める"),
        ("初の公式封鎖宣言", "米軍が軍事力を増強して以降、イランがホルムズ海峡の閉鎖を公式に発表したのは今回が初めて"),
    ],
    big_picture_history=(
        "ホルムズ海峡は幅わずか33kmの狭隘な水路であり、ペルシャ湾と外洋を結ぶ唯一の海上ルートだ。"
        "この地理的ボトルネックは、20世紀以降の国際政治において繰り返し「戦略的人質」として機能してきた。\n\n"
        "1980年代のイラン・イラク戦争中、両国はペルシャ湾を航行するタンカーを相互に攻撃する「タンカー戦争」を展開した。"
        "この時期、米海軍はクウェートのタンカー護衛作戦（アーネスト・ウィル作戦）を実施し、"
        "1988年にはイラン海軍の半数を壊滅させるプレイング・マンティス作戦を敢行した。\n\n"
        "2018年、トランプ第1期政権がイラン核合意（JCPOA）から離脱して以降、ペルシャ湾の緊張は再び高まった。"
        "2019年にはオマーン湾でのタンカー攻撃事件、米軍ドローンの撃墜、イランによる英国タンカーの拿捕が相次いだ。"
        "しかし、イランが海峡自体の「閉鎖」を公式に宣言したのは、2026年2月17日が事実上初めてだ。\n\n"
        "この行動の背景には、二重の圧力がある。外からはトランプ政権による「最大限圧力2.0」"
        "——空母2隻の派遣と「合意しなければ結果がある」という明示的な軍事威嚇。"
        "内からはイラン経済の疲弊——制裁下のインフレ率は40%を超え、通貨リアルは対ドルで史上最安値圏にある。"
        "ハメネイ体制は、体制生存のために「強さの誇示」と「制裁解除の交渉」を同時に遂行しなければならない。"
    ),
    stakeholder_map=[
        ("イラン（IRGC / ハメネイ体制）", "軍事演習は主権の範囲内。核の平和利用の権利を主張", "制裁解除を最優先に追求。封鎖カードは交渉レバレッジ。体制生存が最終目的", "交渉テコ確保、国内強硬派への示威、抑止力の誇示", "国際的孤立深化、報復攻撃リスク、自国原油輸出への跳ね返り"),
        ("米国（トランプ政権）", "イランの核武装は絶対に許さない", "中間選挙前の強い指導者イメージ。イスラエル支持基盤への配慮。石油価格の過度な上昇は回避したい", "最大限圧力で有利な核合意、軍需産業の活性化", "石油価格急騰→国内インフレ、新たな中東戦争のリスク"),
        ("湾岸諸国（サウジ・UAE）", "地域安定と航行の自由を支持", "石油輸出ルートの安全確保が死活的利益。米国の安全保障の傘に依存しつつイランとの直接衝突は回避", "原油価格の適度な上昇は増収", "海峡封鎖なら自国経済も壊滅的打撃"),
        ("石油消費国（日本・韓国・インド）", "航行の自由と安定供給を要求", "日量1,300万バレルの供給途絶は世界的エネルギー危機に直結", "なし（純粋なリスクテイカー）", "原油高騰、インフレ加速、景気後退リスク"),
        ("中国・ロシア", "対話と外交的解決を支持", "中国はイラン産原油の最大輸入国。米・イラン緊張は米国の軍事資源を分散させる利点", "米国の中東関与増大→インド太平洋での圧力低下", "グローバル経済混乱は中国経済にもマイナス"),
    ],
    data_points=[
        ("日量1,300万バレル", "ホルムズ海峡を通過する原油量。世界の海上原油輸送の31%"),
        ("$67.50/バレル", "封鎖発表後のブレント原油価格。全面封鎖なら$100超"),
        ("空母2隻", "USS Gerald Ford + USS Abraham Lincoln。史上最大級の海軍戦力を集中"),
        ("60%濃縮", "イランのウラン濃縮到達レベル。兵器級90%まであと一歩"),
        ("33km", "ホルムズ海峡の最狭部。世界経済のボトルネック"),
        ("3時間", "今回の海峡閉鎖時間。シグナルとしての効果は持続"),
    ],
    delta="ホルムズ海峡の一時封鎖は軍事演習としては小規模だが、「イランは本当にやる」というシグナルの重大さは計り知れない。",
    dynamics_tags="対立の螺旋 × 危機便乗",
    dynamics_summary="米軍の増強がイランの示威行動を呼び、両者が危機の継続から利益を得る構造。",
    dynamics_sections=[
        {
            "tag": "対立の螺旋",
            "subheader": "Escalation Spiral",
            "lead": "米軍の増強がイランの示威行動を呼び、それがさらなる米軍展開を正当化する悪循環が回り続ける。",
            "quotes": [
                ("軍艦は確かに危険な兵器だが、それを沈める兵器のほうがもっと危険だ", "ハメネイ師（イラン最高指導者）"),
                ("合意しなければ、その結果がどうなるか分かっているはずだ", "トランプ大統領（Air Force One機上）"),
                ("合意への道は始まったが、すぐには到達しない", "アラグチ外相（イラン）"),
            ],
            "analysis": (
                "ホルムズ海峡の力学は、古典的なエスカレーション・スパイラルの教科書的事例だ。"
                "トランプ政権が空母2隻を中東に派遣すると、イランは「威嚇には屈しない」と国内世論に示す必要がある。"
                "そこでIRGCが軍事演習を実施し、ミサイル発射映像を公開する。すると米国は「イランの挑発行為」として "
                "さらなる軍事力増強を正当化する。この構造では、どちらの側も「先にエスカレーションを止める」インセンティブがない。\n\n"
                "しかし、今回のケースには重要なニュアンスがある。イランの海峡封鎖は「数時間」で解除された。"
                "これは全面封鎖ではなく、シグナリング（信号送信）だ。イランのメッセージは明確で、"
                "「我々にはこの能力がある。次は本気でやるかもしれない」というものだ。"
                "核協議の席で使う交渉カードとして、最も効果的な「見せ札」を切ったのだ。\n\n"
                "この対立の螺旋が危険なのは、いずれかの側が「見せ札」を「実弾」と誤認した瞬間に、"
                "制御不能のエスカレーションが始まる点にある。1988年のイラン航空655便撃墜事件は、"
                "まさにそのような誤認の連鎖が引き起こした悲劇だった。\n\n"
                "もう一つの危険は、国内政治の力学だ。トランプ大統領にとって「弱腰」に見えることは政治的死を意味し、"
                "ハメネイ師にとって「譲歩」は革命体制の正統性を揺るがす。"
                "両指導者とも、デスカレーション（緊張緩和）の政治的コストが高い。"
                "この構造的なインセンティブの歪みが、対立の螺旋を自己強化する。"
            ),
        },
        {
            "tag": "危機便乗",
            "subheader": "Crisis Exploitation",
            "lead": "イランは軍事危機を交渉テコに転換し、米国は危機を国内政治のツールに変換する。双方が危機の「消滅」を望んでいない。",
            "quotes": [
                ("限定的な軍事衝突ならブレント原油は$80に、海峡の本格封鎖なら$100を超え、世界の石油供給の20%が途絶する", "CNBC市場分析"),
                ("安全と航行の原則を遵守するため、スマートコントロール演習の間、海峡の一部を数時間閉鎖する", "イラン国営ファルス通信"),
            ],
            "analysis": (
                "「危機便乗」とは、一方のアクターが危機的状況を意図的に作り出し（または利用し）、"
                "平時では不可能な譲歩を引き出す力学パターンだ。\n\n"
                "イラン側の計算は精緻だ。核協議のテーブルで「制裁解除」という本丸を勝ち取るために、"
                "ホルムズ海峡という世界経済の急所を「人質」にとる。完全封鎖は自国経済にもダメージを与えるため実行しないが、"
                "「封鎖できるという事実」を世界に見せるだけで十分な交渉テコになる。"
                "原油価格が$67.50に上昇した事実が、このカードの有効性を証明している。\n\n"
                "米国側もまた、この危機を便乗的に利用する。トランプ政権にとって、"
                "「イランの脅威」は国防予算の増額、軍需産業の活性化、そして中間選挙に向けた "
                "「強い指導者」イメージの構築に直結する。外交的解決は望むが、"
                "危機が完全に消滅すると政治的ツールとしての価値も失われる。\n\n"
                "この「双方が危機の継続から利益を得る」構造が、ホルムズ海峡危機が容易に解決しない根本的な理由だ。"
                "アナリストの多くは「全面封鎖の確率は低い」と評価するが、それは逆説的に、"
                "この危機が「低強度の慢性的リスク」として長期化することを意味する。\n\n"
                "世界の石油消費国——特に日本、韓国、インドのようにホルムズ海峡依存度が高い国々——は、"
                "この力学の「人質」として永遠にリスクプレミアムを払い続ける。"
                "中東の緊張が「解決」されないことこそが、複数のアクターにとっての均衡状態なのだ。"
            ),
        },
    ],
    dynamics_intersection=(
        "対立の螺旋と危機便乗は、ホルムズ海峡で交差する。"
        "軍事的エスカレーションが交渉テコとして機能し、交渉テコの行使がさらなるエスカレーションを呼ぶ。"
        "イランにとって「海峡を閉じる能力」は核兵器に代わる究極の抑止力であり、"
        "米国にとって「海峡を守る」という使命は中東関与を正当化する永続的な理由になる。\n\n"
        "この二つの力学が噛み合うことで、ペルシャ湾の緊張は構造的に自己再生産される。"
        "世界がこの構造を変えるには、ホルムズ海峡の戦略的価値そのものを低下させる必要がある"
        "——つまり、石油への依存を根本的に減らすか、代替輸送ルートを確保するしかない。"
        "皮肉にも、再生可能エネルギーへの移行が最も効果的な「中東平和政策」かもしれない。"
    ),
    pattern_history=[
        {"year": "1988", "title": "タンカー戦争 → プレイング・マンティス作戦", "content": "イラン・イラク戦争中、両国がペルシャ湾のタンカーを相互に攻撃する「タンカー戦争」が勃発。米海軍はクウェートのタンカー護衛作戦（アーネスト・ウィル作戦）を実施した。1988年4月、フリゲート艦サミュエル・B・ロバーツが機雷に触れたことを契機に、米海軍は「プレイング・マンティス作戦」を発動し、イラン海軍の半数を数時間で壊滅させた。これはWWII以降最大の米海軍水上戦闘となった。", "similarity": "ホルムズ海峡での小規模な衝突が数時間で大規模海戦にエスカレートし得る。当時イランは米海軍の能力を大幅に過小評価していた。"},
        {"year": "2019", "title": "ペルシャ湾タンカー攻撃 + 米ドローン撃墜", "content": "トランプ第1期政権がJCPOAから離脱し「最大限圧力」を開始した後、2019年5-6月にオマーン湾でタンカー攻撃が発生。6月にはイランが米軍ドローン（RQ-4A）を撃墜。トランプは報復攻撃を命じたが発射10分前に撤回。「150人が死ぬと聞いて中止した」と説明した。", "similarity": "エスカレーションの「瀬戸際」は実在し、大統領の判断で数分のうちに戦争が回避された。イランは「グレーゾーン」の手段を好む。"},
        {"year": "1956", "title": "スエズ危機 — チョークポイントの政治力学", "content": "エジプトのナセル大統領がスエズ運河を国有化し、英仏イスラエルが軍事介入。しかし米ソの圧力で撤退を余儀なくされた。ナセルは「運河の国有化」という一枚のカードで旧植民地体制を揺さぶり、アラブ世界の英雄となった。チョークポイントの支配が国際秩序を変えた歴史的事例だ。", "similarity": "「地理的チョークポイントの支配者が非対称な交渉力を持つ」構造は同一。ただし2026年にはイランの60%濃縮ウランという核変数が加わり、力学は格段に危険になっている。"},
    ],
    history_pattern_summary="3つの事例が示すパターンは明確だ。チョークポイントを巡る危機は、(1)小規模な挑発が (2)意図せずエスカレートし、(3)大きな代償を払った後に (4)外交的解決に回帰する。2026年のホルムズ海峡はまだ(1)の段階にあるが、(2)への移行はわずかな誤算で起こり得る。",
    scenarios=[
        ("基本シナリオ: 慢性的緊張の持続", "55-60%", "核協議は「合意に向けた枠組み」で合意するが、最終合意には至らない。米国はイラン周辺の軍事プレゼンスを維持し、イランは定期的に軍事演習で示威行動を繰り返す。原油価格にはリスクプレミアム$3-5が恒常的に上乗せ。", "エネルギー関連ETFのヘッジポジション維持。中東リスクを織り込んだポートフォリオ配分。"),
        ("楽観シナリオ: 限定的核合意", "20-25%", "イランが60%濃縮の凍結に合意し、米国が一部制裁を段階的に緩和する「小さな取引」が成立。ホルムズ海峡の緊張は大幅に緩和。原油価格は$60-63に下落。", "原油ショートポジションの検討。中東関連インフラ投資への注目。"),
        ("悲観シナリオ: 軍事衝突→海峡封鎖", "15-20%", "偶発的な衝突をきっかけに軍事エスカレーションが発生。イランがホルムズ海峡を本格的に封鎖し、原油価格は$100を突破。各国の戦略石油備蓄が放出される。", "原油ロングポジション、防衛関連銘柄、金のヘッジ。"),
    ],
    triggers=[
        ("IRGC vs 米海軍の偶発的衝突", "演習中の誤射や民間船誤認が即座にエスカレーションのトリガーに"),
        ("核協議の決裂", "交渉失敗→トランプが軍事オプションを検討→イランが対抗措置"),
        ("イランの核開発進展", "90%濃縮到達の情報→イスラエルの先制攻撃の蓋然性が急上昇"),
        ("原油価格の急変動", "$80超→消費国の外交的介入加速。$50以下→イランの経済的絶望感増大"),
    ],
    genre_tags="地政学・安全保障",
    event_tags="軍事・安全保障",
    source_urls=[
        ("Washington Post", "https://www.washingtonpost.com/world/2026/02/17/iran-us-nuclear-talks-iaea/"),
        ("The National", "https://www.thenationalnews.com/news/mena/2026/02/17/iran-strait-of-hormuz-closure/"),
        ("CNBC", "https://www.cnbc.com/2026/02/17/iran-us-strait-of-hormuz-oil-nuclear-talks-geneva.html"),
        ("CBS News", "https://www.cbsnews.com/news/us-iran-talks-geneva-trump-military-threat/"),
        ("NBC News", "https://www.nbcnews.com/world/iran/us-iran-hold-high-stakes-nuclear-talks-geneva-threat-war-looms-rcna259304"),
        ("時事通信", "https://www.jiji.com/jc/article?k=2026021600873&g=int"),
        ("日経新聞", "https://www.nikkei.com/article/DGXZQOGR16A9Q0W6A210C2000000/"),
        ("Newsweek Japan", "https://www.newsweekjapan.jp/headlines/world/2026/02/587847.php"),
    ],
    related_articles=[],
    diagram_html=diagram_svg,
)

# ===================================================================
# 3. Ghost投稿
# ===================================================================
print("=" * 60)
print("STEP 1: Ghost投稿")
print("=" * 60)

import re
text_only = re.sub(r'<[^>]+>', '', html)
text_only = re.sub(r'\s+', ' ', text_only).strip()
char_count = len(text_only)
word_count_est = char_count * 2 // 3
print(f"記事サイズ: {len(html):,} chars HTML, {char_count:,} chars text, ~{word_count_est:,} 語")

admin_api_key = ""
cron_env = "/opt/cron-env.sh"
if os.path.exists(cron_env):
    with open(cron_env) as f:
        for line in f:
            if "NOWPATTERN_GHOST_ADMIN_API_KEY" in line and "=" in line:
                val = line.split("=", 1)[1].strip().strip('"').strip("'")
                if val:
                    admin_api_key = val
                    break

if not admin_api_key:
    print("ERROR: NOWPATTERN_GHOST_ADMIN_API_KEY not found")
    sys.exit(1)

result = publish_deep_pattern(
    article_id=article_id,
    title="イランがホルムズ海峡を一時封鎖した構造 — 世界の石油の20%を人質にとる交渉術",
    html=html,
    genre_tags=["地政学・安全保障"],
    event_tags=["軍事・安全保障"],
    dynamics_tags=["対立の螺旋", "危機便乗"],
    dynamics_tags_en=["Escalation Spiral", "Crisis Exploitation"],
    source_urls=["https://www.washingtonpost.com/world/2026/02/17/iran-us-nuclear-talks-iaea/", "https://www.cnbc.com/2026/02/17/iran-us-strait-of-hormuz-oil-nuclear-talks-geneva.html"],
    word_count_ja=word_count_est,
    title_en="The Structure Behind Iran's Strait of Hormuz Closure",
    ghost_url="https://nowpattern.com",
    admin_api_key=admin_api_key,
    status="published",
    index_path="/opt/shared/nowpattern_article_index.json",
)

ghost_url = result.get("url", "")
print(f"\nGhost URL: {ghost_url}")

# ===================================================================
# 4. X投稿
# ===================================================================
print("\n" + "=" * 60)
print("STEP 2: X投稿")
print("=" * 60)

tweet_text = """【NOW PATTERN】イランがホルムズ海峡を一時封鎖した構造

世界の石油20%が通過するホルムズ海峡を、イラン革命防衛隊が初めて公式に一時封鎖。

■ 対立の螺旋
米空母2隻派遣→IRGC演習→さらなる増強
ハメネイ「軍艦を沈める兵器のほうが危険」

■ 危機便乗
イラン: 封鎖カードで制裁解除を交渉
米国: 危機を国内政治ツールに転換

■ 3シナリオ
基本(55-60%): 慢性的緊張、原油+$3-5
楽観(20-25%): 限定核合意、原油$60-63
悲観(15-20%): 軍事衝突→$100超"""

if ghost_url:
    tweet_text += f"\n\n詳細分析: {ghost_url}"
tweet_text += "\n\n#Nowpattern #ホルムズ海峡 #イラン #地政学 #原油"

try:
    from twikit import Client
    import asyncio

    async def post_tweet():
        client = Client("ja")
        cookie_path = "/opt/.x-cookies.json"
        if os.path.exists(cookie_path):
            client.load_cookies(cookie_path)
            r = await client.create_tweet(tweet_text)
            print(f"OK: Posted to X -> https://x.com/aisaintel/status/{r.id}")
        else:
            print("ERROR: X cookies not found at " + cookie_path)

    asyncio.run(post_tweet())
except Exception as e:
    print(f"X post: {e}")
    print("Manual tweet text:")
    print(tweet_text)

print("\n" + "=" * 60)
print("DONE")
print("=" * 60)
