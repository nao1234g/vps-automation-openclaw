# ============================================================================
# Alertmanager Configuration Example
# ============================================================================
#
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ç”¨:
# cp docker/alertmanager/alertmanager.yml.example docker/alertmanager/alertmanager.yml
#
# Alertmanager ã¯ Prometheus ã‹ã‚‰å—ã‘å–ã£ãŸã‚¢ãƒ©ãƒ¼ãƒˆã‚’é©åˆ‡ãªé€šçŸ¥å…ˆã«é€ä¿¡ã—ã¾ã™
#
# å¯¾å¿œé€šçŸ¥å…ˆ:
# - Slack
# - Email
# - Telegram
# - Webhook (PagerDuty, Opsgenieç­‰)
#
# ============================================================================

global:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
  resolve_timeout: 5m

  # SMTPè¨­å®šï¼ˆEmailé€šçŸ¥ç”¨ï¼‰
  smtp_from: 'alertmanager@your-domain.com'
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_auth_username: 'your-email@gmail.com'
  smtp_auth_password: 'your-app-password'
  smtp_require_tls: true

# ============================================================================
# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾©
# ============================================================================

templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ============================================================================
# ãƒ«ãƒ¼ãƒˆè¨­å®šï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰
# ============================================================================

route:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
  group_by: ['alertname', 'cluster', 'service']

  # åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å¾…ã¤æ™‚é–“
  group_wait: 10s

  # åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã«æ–°ã—ã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ¥ãŸå ´åˆã®å¾…æ©Ÿæ™‚é–“
  group_interval: 10s

  # åŒã˜ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å†é€ä¿¡ã™ã‚‹é–“éš”
  repeat_interval: 12h

  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€šçŸ¥å…ˆ
  receiver: 'default'

  # ============================================================================
  # é‡è¦åº¦åˆ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
  # ============================================================================

  routes:
    # Critical: å³åº§ã«å…¨é€šçŸ¥å…ˆã¸
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 5m
      repeat_interval: 1h

    # High: Slack + Emailã¸
    - match:
        severity: high
      receiver: 'high-alerts'
      group_wait: 5s
      group_interval: 10m
      repeat_interval: 3h

    # Medium: Slackã®ã¿
    - match:
        severity: medium
      receiver: 'medium-alerts'
      group_wait: 30s
      group_interval: 30m
      repeat_interval: 6h

    # Low: ãƒ­ã‚°ã®ã¿ï¼ˆé€šçŸ¥ãªã—ï¼‰
    - match:
        severity: low
      receiver: 'low-alerts'
      group_wait: 1m
      repeat_interval: 24h

    # ============================================================================
    # ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    # ============================================================================

    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ â†’ DBãƒãƒ¼ãƒ ã¸
    - match:
        service: postgres
      receiver: 'database-team'
      continue: true  # ä»–ã®ãƒ«ãƒ¼ãƒˆã‚‚è©•ä¾¡

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ ã¸
    - match:
        alertname: 'SecurityVulnerability'
      receiver: 'security-team'
      continue: true

# ============================================================================
# é€šçŸ¥å…ˆï¼ˆReceiversï¼‰è¨­å®š
# ============================================================================

receivers:
  # ----------------------------------------------------------------------------
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€šçŸ¥å…ˆï¼ˆå…¨ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰
  # ----------------------------------------------------------------------------
  - name: 'default'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#openclaw-alerts'
        title: '{{ .CommonAnnotations.summary }}'
        text: >-
          {{ range .Alerts }}
            *Alert:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
            *Severity:* {{ .Labels.severity }}
            *Details:*
            {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
            {{ end }}
          {{ end }}
        send_resolved: true

  # ----------------------------------------------------------------------------
  # Critical ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆè¤‡æ•°é€šçŸ¥å…ˆï¼‰
  # ----------------------------------------------------------------------------
  - name: 'critical-alerts'
    # Slacké€šçŸ¥
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#openclaw-critical'
        title: 'ğŸš¨ CRITICAL ALERT'
        text: >-
          *{{ .CommonAnnotations.summary }}*

          {{ range .Alerts }}
          *Description:* {{ .Annotations.description }}
          *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          *Labels:*
          {{ range .Labels.SortedPairs }}  â€¢ {{ .Name }}: {{ .Value }}
          {{ end }}
          {{ end }}
        color: 'danger'
        send_resolved: true

    # Emailé€šçŸ¥
    email_configs:
      - to: 'admin@your-domain.com'
        from: 'alertmanager@your-domain.com'
        subject: 'ğŸš¨ CRITICAL: {{ .CommonAnnotations.summary }}'
        html: |
          <h2>ğŸš¨ Critical Alert</h2>
          <p><strong>{{ .CommonAnnotations.summary }}</strong></p>
          <ul>
          {{ range .Alerts }}
            <li>
              <strong>Description:</strong> {{ .Annotations.description }}<br>
              <strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}<br>
              <strong>Labels:</strong>
              <ul>
              {{ range .Labels.SortedPairs }}
                <li>{{ .Name }}: {{ .Value }}</li>
              {{ end }}
              </ul>
            </li>
          {{ end }}
          </ul>
        send_resolved: true

    # Telegramé€šçŸ¥
    telegram_configs:
      - bot_token: 'YOUR_TELEGRAM_BOT_TOKEN'
        chat_id: YOUR_CHAT_ID
        message: |
          ğŸš¨ *CRITICAL ALERT*

          *{{ .CommonAnnotations.summary }}*

          {{ range .Alerts -}}
          ğŸ“ {{ .Annotations.description }}
          â° Started: {{ .StartsAt.Format "15:04:05" }}
          {{ range .Labels.SortedPairs -}}
          â€¢ {{ .Name }}: `{{ .Value }}`
          {{ end }}
          {{ end }}
        parse_mode: 'Markdown'
        send_resolved: true

  # ----------------------------------------------------------------------------
  # High ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆSlack + Emailï¼‰
  # ----------------------------------------------------------------------------
  - name: 'high-alerts'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#openclaw-alerts'
        title: 'âš ï¸ High Priority Alert'
        text: '{{ .CommonAnnotations.summary }}\n{{ .CommonAnnotations.description }}'
        color: 'warning'
        send_resolved: true

    email_configs:
      - to: 'team@your-domain.com'
        subject: 'âš ï¸ HIGH: {{ .CommonAnnotations.summary }}'

  # ----------------------------------------------------------------------------
  # Medium ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆSlackã®ã¿ï¼‰
  # ----------------------------------------------------------------------------
  - name: 'medium-alerts'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#openclaw-monitoring'
        title: 'âš¡ Medium Priority Alert'
        text: '{{ .CommonAnnotations.summary }}'
        color: '#FFA500'
        send_resolved: true

  # ----------------------------------------------------------------------------
  # Low ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆãƒ­ã‚°ã®ã¿ï¼‰
  # ----------------------------------------------------------------------------
  - name: 'low-alerts'
    # é€šçŸ¥ãªã—ï¼ˆAlertmanagerå†…éƒ¨ã§è¨˜éŒ²ã®ã¿ï¼‰

  # ----------------------------------------------------------------------------
  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ãƒ 
  # ----------------------------------------------------------------------------
  - name: 'database-team'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#database-alerts'
        title: 'ğŸ’¾ Database Alert'
        text: |
          *{{ .CommonAnnotations.summary }}*
          {{ .CommonAnnotations.description }}
        send_resolved: true

    email_configs:
      - to: 'db-team@your-domain.com'
        subject: 'ğŸ’¾ DB Alert: {{ .CommonAnnotations.summary }}'

  # ----------------------------------------------------------------------------
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ 
  # ----------------------------------------------------------------------------
  - name: 'security-team'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#security-alerts'
        title: 'ğŸ”’ Security Alert'
        text: |
          *{{ .CommonAnnotations.summary }}*
          {{ .CommonAnnotations.description }}
        color: 'danger'
        send_resolved: true

    email_configs:
      - to: 'security@your-domain.com'
        subject: 'ğŸ”’ Security Alert: {{ .CommonAnnotations.summary }}'

# ============================================================================
# æŠ‘åˆ¶ãƒ«ãƒ¼ãƒ«ï¼ˆInhibition Rulesï¼‰
# ============================================================================
# ç‰¹å®šã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç«ã—ã¦ã„ã‚‹æ™‚ã€ä»–ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶

inhibit_rules:
  # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ€ã‚¦ãƒ³æ™‚ã¯ã€ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä»–ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      severity: 'critical'
      alertname: 'InstanceDown'
    target_match:
      severity: 'warning'
    equal: ['instance']

  # Criticalã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«æ™‚ã€åŒã˜ã‚µãƒ¼ãƒ“ã‚¹ã®Mediumã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'medium'
    equal: ['service']

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ€ã‚¦ãƒ³æ™‚ã€æ¥ç¶šã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      alertname: 'PostgreSQLDown'
    target_match:
      alertname: 'DatabaseConnectionError'
    equal: ['instance']

# ============================================================================
# è¨­å®šä¾‹ï¼šPagerDutyçµ±åˆ
# ============================================================================

# receivers:
#   - name: 'pagerduty'
#     pagerduty_configs:
#       - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'
#         description: '{{ .CommonAnnotations.summary }}'
#         details:
#           firing: '{{ .Alerts.Firing | len }}'
#           resolved: '{{ .Alerts.Resolved | len }}'
#           severity: '{{ .CommonLabels.severity }}'

# ============================================================================
# è¨­å®šä¾‹ï¼šOpsgenieçµ±åˆ
# ============================================================================

# receivers:
#   - name: 'opsgenie'
#     opsgenie_configs:
#       - api_key: 'YOUR_OPSGENIE_API_KEY'
#         message: '{{ .CommonAnnotations.summary }}'
#         description: '{{ .CommonAnnotations.description }}'
#         priority: 'P{{ if eq .CommonLabels.severity "critical" }}1{{ else if eq .CommonLabels.severity "high" }}2{{ else }}3{{ end }}'

# ============================================================================
# è¨­å®šä¾‹ï¼šWebhookï¼ˆã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ï¼‰
# ============================================================================

# receivers:
#   - name: 'custom-webhook'
#     webhook_configs:
#       - url: 'https://your-webhook-endpoint.com/alerts'
#         send_resolved: true
#         http_config:
#           basic_auth:
#             username: 'alert-user'
#             password: 'secret-password'

# ============================================================================
# ãƒ†ã‚¹ãƒˆ
# ============================================================================
#
# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼:
# docker compose -f docker-compose.monitoring.yml exec alertmanager \
#   amtool check-config /etc/alertmanager/alertmanager.yml
#
# ãƒ†ã‚¹ãƒˆã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡:
# curl -H "Content-Type: application/json" -d '[{
#   "labels": {
#     "alertname": "TestAlert",
#     "severity": "critical"
#   },
#   "annotations": {
#     "summary": "Test alert from Alertmanager",
#     "description": "This is a test"
#   }
# }]' http://localhost:9093/api/v1/alerts
#
# ============================================================================
